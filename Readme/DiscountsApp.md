# Скидки (приложение discounts_app)

## Модели

Предусмотрено три вида (модели) скидок: *productdiscount*, *groupdiscount*, *cartdiscount*.
Все скидки привязаны к конкретному магазину (один ко многим)

<u>*Productdiscount*</u> действуют на выбранный товар или товары. Отношение скидка-товар много-ко-многим: на один и тот же
товар могут быть заведены несколько скидок, и скидка может действовать на несколько товаров.

<u>*Groupdiscount*</u> действует на категорию товаров в магазине. Например, скидка 3% на все компьютеры.

<u>*Cartdiscount*</u> применяется к товарам в корзине в зависимости от количества товаров в корзине или общей стоимости товаров в корзине.
Например, если в корзине больше 3 товаров или общая стоимость больше 3000 р., то применяется скидка в 3%.

Все три вида скидок делятся на три типа: скидка в процентах, скидка - фиксированная сумма, фиксированная новая (акционная цена).
Например, скидка в 5% или скидка в 150 р. или установленная акционная цена в 1225 р.

Кроме того товарные скидки (Productdiscount) могут иметь атрибут set_discount (скидка на набор).
В этом случае скидка применяется к набору, т.е. только если все товары, на которые установлена эта скидка,
попали в корзину.
Например, при покупке телефона и чехла скидка 200 р. Если хотя бы один из товаров не попал в корзину,
скидка не применяется.

Все скидки можно отразить в таблице:

| Type/sort    | Productdiscount | Groupdiscount | Cartdiscount |
|--------------|-----------------|---------------|--------------|
| Percent      | regular or set  |               |              |
| Fixed amount | regular or set  |               |              |
| Fixed price  | regular or set  |               |              |

Также все скидки имеют три уровня приоритетности: низкий, средний и высокий, что позводяет применять
все виды скидок комплексно.

Пример комплексного применения скидок
Скидка на корзину от 3 товаров - 5% с низким приоритетом.
Скидка на телефоны - 150 руб. со средним приоритетом.
Скидка на конкретный телефон А с чехлом - 500 руб. с высоким приоритетом.

Демонстрация списка и детальной страницы скидок
Демонстрация на магазине

На главной странице, странице скидок и предложений и др возможных местах отображаются товарные скидки.
На страницк списка скидок 

##Представления и шаблоны

В приложении используются 2 представления и 2 шаблоеа для отображения Товарных скидок (ProductDiscount):
* список скидок
* детальная страница скидок

## Сервис

Сервис расчета скидок реализован для работы с товарамм продавца (SellerProduct) и товарами в корзине (OrderProduct).
Расчет скидок на товары продавца используется для отображения цен со скидками на главной странице, в каталоге, на детальной
странице скидок и т.д. На вход метод получает список (queryset) товаров продавца с необязательным аргументом скидка по умолчанию.
При наличии скидки по умолчанию цена со скидкой расчитывается только по этой скидке. В противном случае выбирается список 
приоритетных скидок и из них выбирается скидка c минимальным эффектом (минимальная в абсолютном выражении)

Результат работы метода - зип объект кортежей: (товар продавца, сумма со скидкой, сама товарная скидка). Такой алгоритм
позволяет отображать один и тот же товар с разными скидками на разных страницах.
Например: на телефон действует спец скидка -10% и он отображается на странице популярных товаров
с этой скидкой, но также на этот телефон в комплекте с чехлом действует скидка -1000 р. и это будет в списке спец предложений.

Для отображения скидок в корзине сервис расчета скидок получает инициализироваться объектом корзины.
Определяются все возможные скидки, применимые ко всем товарам в корзине, отсеиваются корзинные скидки и скидки
на наборы и повторяющиеся скидки.

Для каждого товара в корзине расчитываюься приоритетные скидки и определяется пересечение множеств скидок применимых к корзине
со множеством прилритетных скидок конкретного товара. Из оставшихся скидок применяется скидка с минимальным абсолютным эффектом.
На выходе сервис отдает цену со скидкой или начальную цену, если скидки не применились.

В сервисе использованы вспомогательные методы по проверке применимости корзинных скидок и скидок на наборы, а также метод вычисления 
цены со скидкой в зависимости от вида и тиав скидки.

Этот алгоритм позволяет применять "на лету" разные скидки в зависимости от состояния корзины.
Сервис работает как с корзиной анонимного пользователя, так и с корзиной залогиненного пользователя.

# Баннеры

Три рандомных баннера закэшированы на 10 минут.
Баннер привязан к товарной скидке отношением 1-к-1