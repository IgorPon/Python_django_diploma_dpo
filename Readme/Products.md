# Главная страница

Главная страница состоит из следующих элементов:
 - header;
 - блок баннеров;
 - блок "случайные категории";
 - блок "популярные товары" ;
 - блок "горячие предложения";
 - блок "ограниченный тираж";
 - блок "ограниченное предложение";
 - footer.

Базовое представление - `goods_app.views.IndexView`.
Вся логика блоков, их backend, находятся в модуле `goods_app.services.limited_products`.

## Кастомный тэг `cards`
Для вывода карточек товара используется кастомный тэг `cards`, который имеет несколько вариантов использования под разные блоки сайта:
```python
@register.inclusion_tag('elems/card.html')
def cards(products, **kwargs):
    slider = False
    exclude = -1
    seller_perm = False
    if kwargs.get('seller_perm'):
        seller_perm = True
    if kwargs.get('slider'):
        slider = True
    if kwargs.get('exclude'):
        exclude = kwargs['exclude']
    return {
        'products': products,
        'slider': slider,
        'exclude': exclude,
        'seller_perm': seller_perm
    }
```
Как видно из кода, тэг принимает в себя необязательные именованные аргументы. Это может быть например `seller_perm`, который используется для показа товаров в комнате для продавцов. 
Этот аргумент добавляет элементы удаления и редактирования товара. Аргумент `slider` используется, когда карточки нужно поместить внутрь js-слайдера. 
`exclude` необходим для исключения определенного товара из выборки - это используется в блоке "ограниченный тираж".

## header
Блок header содержит главное меню, ссылки на соцсети, строку поиска и каталог. 
Поскольку это демонстрационная версия, то само собой ссылок на соцсети нет, однако простым фронтенд-методом это легко исправить при необходимости.
Данный блок разделен на два шаблона, меню вынесена в отдельный файл `elems/menu_head.html`, который подключается непосредственно в `elems/header.html`.

## Блок баннеров
Подключается из файла `elems/banners.html`. Данный блок кешируется непосредственно в шаблоне.

## Блок "случайные категории"
Выводится три случайные категории, каждый раз при обновлении страницы. Данный блок не кешируется, чтобы быть более интерактивным.
Шаблон подключается в `index.html` из файла `elems/random_categories.html`. Непосредственно логика выборки находится в функции:
```python
def get_random_categories():
    queryset = categories.annotate(count=Count('products__seller_products'), from_price=Min('products__seller_products__price')).exclude(count=0)
    try:
        random_categories = random.choices(population=list(queryset), k=3)
    except IndexError:
        return None
    return random_categories
```
Использование `try-except` в данном методе необходимо для случая, когда все категории пусты. 
Как правило, такое может произойти при первом запуске сайта, который еще не наполнен контентом. 
Аналогичное использование try-except имеется и в последующих функциях.

## Блок "популярные товары"
Основной блок, содержащий выборку части товаров, отсортированных по количеству оплаченных ордеров, в которых встречался товар.
Отдельного шаблона на этот блок нет, в самом шаблоне `index.html` используется кастомный тэг `cards` без аргументов, для вывода карточек товаров. 

## Блок "горячие предложения"
В этот блок попадают товары, на которые имеется хотя бы одна скидка. Поскольку в проекте существует три вида скидок, то в данную выборку попадают только те товары, у которых есть именно тип скидки на продукт.
Шаблон подключается в `index.html` из файла `elems/hot_offers.html`.

## Блок "ограниченный тираж"
У каждого базового продукта есть булевое поле `limited`. В данную категорию попадают те товары продавцов, у базовых товаров которых данное поле имеет значение `True`.
Шаблон подключается в `index.html` из файла `elems/limited_products.html`

## Блок "ограниченное предложение"
Этот блок находится отдельно от предыдущего, и в него попадает только один товар из блока "ограниченный тираж".  
За метод выборки такого товара отвечает функция `get_limited_deal`. 
По умолчанию это просто случайный товар из "ограниченного тиража", однако при необходимости можно просто переопределить данную функцию для определениея иного метода выбора.
Шаблон подключается в `index.html` из файла `elems/special_product.html`.

## footer
Это статичный блок, который подключается из файла `elems/footer.html`.


# Детальная страница товара
Шаблон страницы находится в файле `goods_app/product.html`. В нем содержится вся информация о базовом продукте, которая берется из соответствующей модели.
Базовое представление - `goods_app.views.ProductDetailView`.
Вся логика блоков, их backend, находятся в модуле `goods_app.services.product_detail`.

## Средняя цена товара
На детальной странице товара указана средняя цена по всем товарам продавцов данного базового товара. 
Данный подсчет выполняет метод `goods_app.Current_product.get_calculate_prices`.

## Добавление в корзину
При добавлении в корзину заданного количества товаров, будет добавлен товар по наиболее выгодной цене с учетом скидок на продукт.
В случае отсутствия товара по самой выгодной цене, данный блок будет скрыт с надписью "нет в наличии". В этом случае стоит искать товар в других магазинах во вкладке "Продавцы" данной страницы.
> ### Примечание:
> При определении товара продавца в данном случае не учитываются корзинные скидки и скидки на группу товаров.

## Отзывы
Отзывы могут добавлять только авторизованные пользователи. При добавлении отзыва необходимо выставить рейтинг товару, который используется в сервисе сравнения.
